# TCP 四次挥手详解

TCP 四次挥手是断开连接的关键步骤。本文将用图解的方式详细讲解四次挥手的全过程。

## 什么是四次挥手？

四次挥手（Four-Way Handshake）是 TCP 协议断开连接的过程，确保客户端和服务器都能安全地关闭连接并释放资源。

## 四次挥手过程

### 第一次挥手（FIN）

主动关闭方（通常是客户端）向对方发送 FIN 包，表示不再发送数据，请求关闭连接。

```
客户端 → 服务器: FIN
```

### 第二次挥手（ACK）

被动关闭方收到 FIN 后，发送 ACK 包，确认收到关闭请求。此时连接进入半关闭状态，被动关闭方仍可以发送数据。

```
服务器 → 客户端: ACK
```

### 第三次挥手（FIN）

被动关闭方发送完所有数据后，发送 FIN 包，表示也要关闭连接。

```
服务器 → 客户端: FIN
```

### 第四次挥手（ACK）

主动关闭方收到 FIN 后，发送 ACK 包，确认关闭。等待 2MSL（最大报文段生存时间）后，连接完全关闭。

```
客户端 → 服务器: ACK
```

## 为什么需要四次挥手？

1. **全双工通信**：TCP 连接是全双工的，需要分别关闭两个方向的连接
2. **数据完整性**：确保双方都发送完所有数据后再关闭
3. **资源释放**：保证双方都能正确释放连接资源

## TIME_WAIT 状态

主动关闭方在发送最后一个 ACK 后会进入 TIME_WAIT 状态，等待 2MSL 时间。这是为了：

- 确保最后一个 ACK 能够到达对方
- 防止旧连接的报文段影响新连接

## 总结

四次挥手确保了 TCP 连接的安全关闭，是网络通信的重要组成部分。理解四次挥手有助于排查网络问题和优化应用性能。

